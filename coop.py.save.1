'''
Coop

A simple yet complete porgram to manage and monitor your coop.

Configuration is done in the config.ini file.
Logging is done to the file specified in this config.ini file

'''

import logging
import configparser
from datetime import datetime, timezone
import RPi.GPIO as GPIO
import time
from suntime import Sun, SunTimeException
#import schedule

#config
config = configparser.ConfigParser()
config.read('config.ini')

#logging
logging.basicConfig(filename=config['Settings']['LogFile'], level=config['Settings']['LogLevel'], format='%(asctime)s - %(levelname)s: %(message)s')

#Suntime
sun = Sun(float(config['Location']['Latitude']), float(config['Location']['Longitude']))
now = datetime.now(timezone.utc)

#GPIO
GPIO.setmode(GPIO.BOARD)
TopSensor= int(config['GPIO']['TopSensor'])
BottomSensor = int(config['GPIO']['BottomSensor'])
GPIO.setup(TopSensor, GPIO.IN, pull_up_down=GPIO.PUD_UP)
GPIO.setup(BottomSensor, GPIO.IN, pull_up_down=GPIO.PUD_UP)
MotorUp = int(config['GPIO']['MotorUp'])
GPIO.setup(MotorUp,GPIO.OUT)
MotorDown = int(config['GPIO']['MotorDown'])
GPIO.setup(MotorDown,GPIO.OUT)

def open_door():
	logging.info ("Door going up")
	GPIO.output(MotorUp,GPIO.HIGH)
	GPIO.output(MotorDown,GPIO.LOW)
	time.sleep(10)
	GPIO.output(MotorUp,GPIO.LOW)

def close_door():
	logging.info ("Door going down")
	GPIO.output(MotorDown,GPIO.HIGH)
	GPIO.output(MotorUp,GPIO.LOW)
	time.sleep(10)
	GPIO.output(MotorDown,GPIO.LOW)

def startup():
	logging.info('Coop started')
	logging.info("The UTC time is: %s", (now))

def door():
	logging.info("Door will open at: %s UTC",(sun.get_sunrise_time()))
	logging.info("Door will close at: %s UTC",(sun.get_sunset_time()))
	if now > sun.get_sunrise_time() and now < sun.get_sunset_time():
		logging.warning("It is day, opening door")
		open_door()
			if GPIO.input(TopSensor) and GPIO.input(BottomSensor) == False:
			logging.info("Door is open")

	else:
		logging.warning("It is night, closing door")
		close_door()

def main_loop():
    while True:
        door()
        time.sleep(.5)

#while True:
#
#
#	if GPIO.input(TopSensor) and GPIO.input(BottomSensor) == False:
#		logging.info("Door is open")
#	elif GPIO.input(BottomSensor) and GPIO.input(TopSensor) == False:
#		logging.info("Door is closed")
#	else:
#		logging.info("Door in between")

#GPIO.cleanup()

if __name__ == "__main__":
    try:
        startup()
        main_loop()
    except RuntimeError as error:
        print(error.args[0])
    except KeyboardInterrupt:
        print("\nExiting application\n")
        # exit the application
        GPIO.cleanup()
